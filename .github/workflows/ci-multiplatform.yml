name: CI Multi-Platform

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'images/**'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'images/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  DEFAULT_PYTHON: "3.12"
  SRC_DIR: src/nmea_gps_emulator
  TEST_DIR: tests

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.DEFAULT_PYTHON }}
          cache: 'pip'

      - name: Install linters
        run: pip install ruff mypy

      - name: Run ruff check
        run: ruff check ${{ env.SRC_DIR }} ${{ env.TEST_DIR }}

      - name: Run ruff format check
        run: ruff format --check ${{ env.SRC_DIR }} ${{ env.TEST_DIR }}

      - name: Run mypy
        run: mypy ${{ env.SRC_DIR }} --ignore-missing-imports

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.DEFAULT_PYTHON }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -e .
          pip install pip-audit

      - name: Run pip-audit
        run: pip-audit

      - name: Check for secrets (Gitleaks)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.12", "3.13"]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-cov

      - name: Run tests with coverage
        run: pytest ${{ env.TEST_DIR }} -v --cov=${{ env.SRC_DIR }} --cov-report=xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: coverage.xml
          fail_ci_if_error: false
          flags: ${{ matrix.os }}-py${{ matrix.python-version }}
          name: ${{ matrix.os }}-py${{ matrix.python-version }}

  # Platform-specific smoke tests
  platform-smoke-tests:
    needs: test
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.DEFAULT_PYTHON }}
          cache: 'pip'

      - name: Install package
        run: pip install -e .

      - name: Test CLI help (Unix)
        if: runner.os != 'Windows'
        run: |
          nmea-gps-emulator --help
          python -m nmea_gps_emulator --help

      - name: Test CLI help (Windows)
        if: runner.os == 'Windows'
        run: |
          nmea-gps-emulator --help
          python -m nmea_gps_emulator --help

      - name: Test CLI flags (Unix)
        if: runner.os != 'Windows'
        run: |
          # Test --quiet flag
          python -m nmea_gps_emulator --quiet --help
          echo "[OK] --quiet flag works"

          # Test --verbose flag
          python -m nmea_gps_emulator --verbose --help
          echo "[OK] --verbose flag works"

          # Test short flags
          python -m nmea_gps_emulator -q --help
          echo "[OK] -q flag works"

          python -m nmea_gps_emulator -v --help
          echo "[OK] -v flag works"

      - name: Test CLI flags (Windows)
        if: runner.os == 'Windows'
        run: |
          # Test --quiet flag
          python -m nmea_gps_emulator --quiet --help
          echo "[OK] --quiet flag works"

          # Test --verbose flag
          python -m nmea_gps_emulator --verbose --help
          echo "[OK] --verbose flag works"

          # Test short flags
          python -m nmea_gps_emulator -q --help
          echo "[OK] -q flag works"

          python -m nmea_gps_emulator -v --help
          echo "[OK] -v flag works"

      - name: Test conflicting flags (Unix)
        if: runner.os != 'Windows'
        run: |
          # Test that --quiet and --verbose together fails with exit code 1
          if python -m nmea_gps_emulator --quiet --verbose 2>&1; then
            echo "[FAIL] Conflicting flags should be rejected"
            exit 1
          else
            echo "[OK] Conflicting flags properly rejected (exit code: $?)"
          fi

      - name: Test conflicting flags (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          # Test that --quiet and --verbose together fails with exit code 1
          if python -m nmea_gps_emulator --quiet --verbose 2>&1; then
            echo "[FAIL] Conflicting flags should be rejected"
            exit 1
          else
            echo "[OK] Conflicting flags properly rejected"
          fi

      - name: Verify imports
        run: |
          python -c "from nmea_gps_emulator.nmea_gps import NmeaMsg; print('[OK] NmeaMsg import successful')"
          python -c "from nmea_gps_emulator.main import Menu; print('[OK] Menu import successful')"
          python -c "from nmea_gps_emulator.utils import position_input; print('[OK] Utils import successful')"
          python -c "from nmea_gps_emulator.custom_thread import NmeaSrvThread; print('[OK] Thread classes import successful')"

      - name: Test NMEA message generation (Unix)
        if: runner.os != 'Windows'
        run: |
          python -c "
          from nmea_gps_emulator.nmea_gps import NmeaMsg

          # Create NMEA object with test data
          position = {
              'latitude_value': '5430.000',
              'latitude_direction': 'N',
              'longitude_value': '01920.000',
              'longitude_direction': 'E'
          }
          nmea = NmeaMsg(position=position, altitude=100.0, speed=10.0, heading=90.0)

          # Generate one set of sentences
          sentences = next(nmea)

          # Verify we got sentences
          assert len(sentences) > 0, 'No NMEA sentences generated'

          # Verify sentence format (should start with $ and contain *)
          for sentence_obj in sentences:
              sentence = str(sentence_obj)  # Convert object to string
              assert sentence.startswith('$'), f'Invalid sentence format: {sentence}'
              assert '*' in sentence, f'Missing checksum in: {sentence}'

          print(f'[OK] Generated {len(sentences)} valid NMEA sentences')
          "

      - name: Test NMEA message generation (Windows)
        if: runner.os == 'Windows'
        run: |
          python -c "from nmea_gps_emulator.nmea_gps import NmeaMsg; position = {'latitude_value': '5430.000', 'latitude_direction': 'N', 'longitude_value': '01920.000', 'longitude_direction': 'E'}; nmea = NmeaMsg(position=position, altitude=100.0, speed=10.0, heading=90.0); sentences = next(nmea); assert len(sentences) > 0; sentence_strs = [str(s) for s in sentences]; assert all(s.startswith('$') and '*' in s for s in sentence_strs); print(f'[OK] Generated {len(sentences)} valid NMEA sentences')"

      - name: Test input validation functions (Unix)
        if: runner.os != 'Windows'
        run: |
          python -c "
          import re
          from nmea_gps_emulator.utils import position_input, heading_input, speed_input

          # Test position regex
          position_regex = re.compile(
              r'^(([0-8]\d[0-5]\d|9000)(N|S|n|s)\s?(([0-1][0-7]\d[0-5]\d)|(0[0-9]\d[0-5]\d)|18000)(E|W|e|w))$',
              re.VERBOSE
          )
          assert position_regex.match('5430N 01920E'), 'Position regex failed'
          print('[OK] Position validation regex works')

          # Test heading regex
          heading_regex = re.compile(r'(3[0-5]\d|[0-2]\d{2}|\d{1,2})')
          assert heading_regex.fullmatch('90'), 'Heading regex failed'
          assert heading_regex.fullmatch('359'), 'Heading regex failed'
          print('[OK] Heading validation regex works')

          # Test speed regex
          speed_regex = re.compile(r'(\d{1,3}(\.\d+)?)')
          assert speed_regex.fullmatch('10.5'), 'Speed regex failed'
          assert speed_regex.fullmatch('999'), 'Speed regex failed'
          print('[OK] Speed validation regex works')
          "

      - name: Test input validation functions (Windows)
        if: runner.os == 'Windows'
        run: |
          python -c "import re; position_regex = re.compile(r'^(([0-8]\d[0-5]\d|9000)(N|S|n|s)\s?(([0-1][0-7]\d[0-5]\d)|(0[0-9]\d[0-5]\d)|18000)(E|W|e|w))$', re.VERBOSE); assert position_regex.match('5430N 01920E'); print('[OK] Input validation works')"

      - name: Check platform detection (Unix)
        if: runner.os != 'Windows'
        run: |
          python -c "
          import platform
          print(f'Platform: {platform.system()}')
          print(f'Python: {platform.python_version()}')
          print(f'Architecture: {platform.machine()}')
          "

      - name: Check platform detection (Windows)
        if: runner.os == 'Windows'
        run: |
          python -c "import platform; print(f'Platform: {platform.system()}'); print(f'Python: {platform.python_version()}'); print(f'Architecture: {platform.machine()}')"

  build:
    needs: [lint, test, platform-smoke-tests]
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.DEFAULT_PYTHON }}
          cache: 'pip'

      - name: Install build tools
        run: pip install build

      - name: Build package
        run: python -m build

      - name: Verify wheel installation (Unix)
        if: runner.os != 'Windows'
        run: |
          pip install dist/*.whl
          nmea-gps-emulator --help

      - name: Verify wheel installation (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          pip install dist/*.whl
          nmea-gps-emulator --help

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dist-${{ matrix.os }}
          path: dist/
          retention-days: 7

  # Summary job to check overall status
  ci-success:
    needs: [lint, security, test, platform-smoke-tests, build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check CI status
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.platform-smoke-tests.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "❌ CI failed"
            exit 1
          else
            echo "✅ All CI checks passed"
          fi
